# @configure_input@

CC=@CC@
LIBS=@LIBS@ @OGG_LIBS@ @VORBIS_LIBS@ @VORBISFILE_LIBS@ @SDL_LIBS@
CPPFLAGS=@CPPFLAGS@
PROG_NAME=@PACKAGE_TARNAME@@EXEEXT@
CFLAGS =-g -Wall -std=c99 @CFLAGS@ @OGG_CFLAGS@ @VORBIS_CFLAGS@ @SDL_CFLAGS@
TAR_NAME=@PACKAGE_TARNAME@-@PACKAGE_VERSION@

ACLOCAL_FLAGS = -I m4

EXTRA_WARNINGS =  -Wextra -Wno-unused-parameter \
	-Wno-char-subscripts -Wno-deprecated-declarations \
	-Werror

# Personal Makefile
-include Makefile.$(LOGNAME)

PROGS = imgsplit vtest decode getport getvab mtest sdltest

EXTRA_SOURCES = README COPYING DEVELOPER ChangeLog \
				raceintospace.1 \
				configure Makefile.in Makefile race.h.in \
				m4

DESTDIR=/

BARIS_HFILES = av.h Buzz_inc.h data.h endianness.h externs.h gamedata.h \
	int_types.h macros.h mis.h music.h pace.h proto.h records.h \
	soundfx.h soundint.h mmfile.h

BARIS_OBJS = admin.o aimast.o aimis.o aipur.o ast0.o ast1.o	    \
	ast2.o ast3.o ast4.o budget.o crew.o endgame.o	    \
	endianness.o \
	futbub.o future.o hardef.o intel.o intro.o main.o mc2.o mc.o \
	mis_c.o mis_m.o museum.o newmis.o news.o news_sup.o	    \
	news_suq.o \
	place.o port.o prefs.o prest.o radar.o rdplex.o records.o \
	replay.o review.o rush.o start.o   \
	vab.o pace.o gx.o gr.o sdl.o music.o gamedata.o

ifeq (@theora_video@,yes)
BARIS_OBJS += mmfile.o  
endif

ifeq (@have_theora@@have_ogg@@have_vorbis@,yesyesyes)
PROGS += vtest2
endif

all: $(PROG_NAME)

extra: all $(PROGS)

rpm_all: raceintospace

install: raceintospace
	mkdir -p $(DESTDIR)/usr/bin
	mkdir -p $(DESTDIR)/usr/share/man/man1
	mkdir -p $(DESTDIR)/usr/share/doc/raceintospace
	mkdir -p $(DESTDIR)/usr/share/raceintospace/music
	install -c -m 755 raceintospace $(DESTDIR)/usr/bin/raceintospace
	gzip < raceintospace.1 \
	   > $(DESTDIR)/usr/share/man/man1/raceintospace.1.gz
	install -c -m 644 README $(DESTDIR)/usr/share/doc/raceintospace/.

rpm_install: install
	cp -pr /usr/share/raceintospace/music/*.ogg \
		$(DESTDIR)/usr/share/raceintospace/music/.

uninstall:
	rm -f $(DESTDIR)/usr/bin/raceintospace
	rm -f $(DESTDIR)/usr/share/man/man1/raceintospace.1*
	rm -rf $(DESTDIR)/usr/share/doc/raceintospace
	rm -f $(DESTDIR)/usr/share/raceintospace/README

# cheat, we still use CC but print LD
$(PROG_NAME): $(BARIS_OBJS)
	@echo "$(LD) ...flags... -o $@ ...libs..."
	@$(CC) $(LDLAGS) -o $(PROG_NAME) $(BARIS_OBJS) $(LIBS)

.c.o:
	@echo "$(CC) ...flags... -c $*.c"
	@$(CC) $(CFLAGS) $(EXTRA_WARNINGS) -O -c -o TMP.o $*.c
	@$(CC) $(CFLAGS) $(EXTRA_WARNINGS) -c $*.c

vtest2: vtest2.o mmfile.o
	$(CC) $(LDFLAGS) -o vtest2 vtest2.o mmfile.o @OGG_LIBS@ @VORBIS_LIBS@ -ltheora @SDL_LIBS@

imgsplit: imgsplit.o
	$(CC) $(CFLAGS) -o imgsplit imgsplit.o -lm

vtest: vtest.o
	$(CC) $(CFLAGS) -o vtest vtest.o -lasound -lm

decode: decode.o
	$(CC) $(CFLAGS) -o decode decode.o -lm

getport: getport.o
	$(CC) $(CFLAGS) -o getport getport.o -lm

getvab: getvab.o
	$(CC) $(CFLAGS) -o getvab getvab.o -lm

mtest: mtest.o
	$(CC) $(CFLAGS) -o mtest mtest.o -lm

sdltest: sdltest.o
	$(CC) $(CFLAGS) -o sdltest sdltest.o @SDL_LIBS@ @VORBISFILE_LIBS@ -lm

FORCE:

tags: FORCE
	ctags *.[ch]

TAGS: FORCE
	etags *.[ch]

cscope: FORCE
	cscope -b

clean:
	rm -f *.o *~
	rm -f $(PROG_NAME)
	rm -f $(PROGS)
	rm -f $(TAR_NAME).*

distclean: clean
	rm -f config.log config.status Makefile
	rm -f int_types.h race.h
	rm -f configure
	rm -rf autom4te.cache

configure: configure.in
	-aclocal $(ACLOCAL_FLAGS)
	autoconf

tar: $(EXTRA_SOURCES)
	rm -f $(TAR_NAME).tar*
	rm -rf .temp
	mkdir -p .temp/$(TAR_NAME)
	(cd .temp/$(TAR_NAME) && ln -s $(addprefix ../../,*.[ch] $(EXTRA_SOURCES)) ./)
	tar -zchC .temp --exclude CVS -f $(TAR_NAME).tar.gz $(TAR_NAME)
